<!DOCTYPE html>
<html lang="en">
  <head>
    <title>
        JVM上篇 - YTTE Site
      </title>
        <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    
    <meta name="theme-color" content="#000000" />
    
    <meta http-equiv="window-target" content="_top" />
    
    
    <meta name="description" content="本篇为面试复习总结篇
详情笔记跳转：https://www.processon.com/view/link/61cbc28e5653bb21ce5bb9c8
" />
    <meta name="generator" content="Hugo 0.95.0 with theme pure" />
    <title>JVM上篇 - YTTE Site</title>
    
    
    <link rel="stylesheet" href="https://gb.ytte.top/css/style.min.4e2a64576431dfa2e755e7ee583c6f3d940d0d51b03a91282457adea3bb6f5c9.css">
    
    <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/9.15.10/styles/monokai.min.css" async>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css" async>
    <meta property="og:title" content="JVM上篇" />
<meta property="og:description" content="本篇为面试复习总结篇
详情笔记跳转：https://www.processon.com/view/link/61cbc28e5653bb21ce5bb9c8" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://gb.ytte.top/2022/04/05/jvm%E4%B8%8A%E7%AF%87/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-05T16:02:39+08:00" />
<meta property="article:modified_time" content="2022-04-05T16:02:39+08:00" />

<meta itemprop="name" content="JVM上篇">
<meta itemprop="description" content="本篇为面试复习总结篇
详情笔记跳转：https://www.processon.com/view/link/61cbc28e5653bb21ce5bb9c8"><meta itemprop="datePublished" content="2022-04-05T16:02:39+08:00" />
<meta itemprop="dateModified" content="2022-04-05T16:02:39+08:00" />
<meta itemprop="wordCount" content="10229">
<meta itemprop="keywords" content="JVM," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="JVM上篇"/>
<meta name="twitter:description" content="本篇为面试复习总结篇
详情笔记跳转：https://www.processon.com/view/link/61cbc28e5653bb21ce5bb9c8"/>

    <!--[if lte IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
      <![endif]-->

    <!--[if lt IE 9]>
        <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
      <![endif]-->
  </head>

  
  

  <body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="https://github.com/YTTE-jx" target="_blank">
            <img class="img-circle img-rotate" src="https://gb.ytte.top/avatar.png" width="200" height="200">
          </a>
          <div id="name" class="hidden-xs hidden-sm H2Tittle">YTTE</div>
          <div id="title" class="hidden-xs hidden-sm hidden-md H2Tittle">努力奋斗，不负韶华。</div>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>Anhui, China</small>
        </div><div class="search" id="search-form-wrap">
    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i
                        class="icon icon-search"></i></button>
            </span>
        </div>
        <div class="ins-search">
            <div class="ins-search-mask"></div>
            <div class="ins-search-container">
                <div class="ins-input-wrapper">
                    <input type="text" class="ins-search-input" placeholder="Type something..."
                        x-webkit-speech />
                    <button type="button" class="close ins-close ins-selectable" data-dismiss="modal"
                        aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="ins-section-wrapper">
                    <div class="ins-section-container"></div>
                </div>
            </div>
        </div>
    </form>
</div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                    <i class="icon icon-home-fill"></i>
                  <span class="menu-title">Home</span>
                </a>
            </li>
            <li class="menu-item menu-item-archives">
                <a href="/posts/">
                    <i class="icon icon-archives-fill"></i>
                  <span class="menu-title">Archives</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories/">
                    <i class="icon icon-folder"></i>
                  <span class="menu-title">Categories</span>
                </a>
            </li>
            <li class="menu-item menu-item-tags">
                <a href="/tags/">
                    <i class="icon icon-tags"></i>
                  <span class="menu-title">Tags</span>
                </a>
            </li>
            <li class="menu-item menu-item-about">
                <a href="/about/">
                    <i class="icon icon-cup-fill"></i>
                  <span class="menu-title">About</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>

<aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <div class="widget-title H3Tittle">Board</div>
    <div class="widget-body">
        <div id="board">
            <div class="content"><p> 人生无常，大肠包小肠~</p>
            </div>
        </div>
    </div>
</div>

      <div class="widget">
    <div class="widget-title H3Tittle"> Tags</div>
    <div id="tag-cloud-list" class="widget-body">
            
            
            <a href="https://gb.ytte.top/tags/bolg/" class="tag-list-link" rel="1">bolg<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/docker/" class="tag-list-link" rel="1">docker<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/git/" class="tag-list-link" rel="1">git<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/gitee/" class="tag-list-link" rel="2">gitee<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://gb.ytte.top/tags/github/" class="tag-list-link" rel="1">github<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/hexo/" class="tag-list-link" rel="1">hexo<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/https/" class="tag-list-link" rel="1">https<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/hugo/" class="tag-list-link" rel="1">hugo<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/index/" class="tag-list-link" rel="1">index<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/java/" class="tag-list-link" rel="3">java<span
               class="tag-list-count">3</span></a>
            
            
            <a href="https://gb.ytte.top/tags/jvm/" class="tag-list-link" rel="1">jvm<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/mysql/" class="tag-list-link" rel="3">mysql<span
               class="tag-list-count">3</span></a>
            
            
            <a href="https://gb.ytte.top/tags/rabbit-mq/" class="tag-list-link" rel="1">rabbit-mq<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/spring-mvc/" class="tag-list-link" rel="1">spring-mvc<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/springboot/" class="tag-list-link" rel="1">springboot<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/springcloud/" class="tag-list-link" rel="1">springcloud<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/thread/" class="tag-list-link" rel="1">thread<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/typora/" class="tag-list-link" rel="1">typora<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/zookeeper/" class="tag-list-link" rel="1">zookeeper<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/%E5%9F%9F%E5%90%8D/" class="tag-list-link" rel="2">域名<span
               class="tag-list-count">2</span></a>
            
            
            <a href="https://gb.ytte.top/tags/%E5%9F%BA%E7%A1%80/" class="tag-list-link" rel="3">基础<span
               class="tag-list-count">3</span></a>
            
            
            <a href="https://gb.ytte.top/tags/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/" class="tag-list-link" rel="1">谷粒商城<span
               class="tag-list-count">1</span></a>
            
            
            <a href="https://gb.ytte.top/tags/%E9%A2%98%E7%9B%AE/" class="tag-list-link" rel="1">题目<span
               class="tag-list-count">1</span></a>
            
    </div>
<script>
document.onreadystatechange = () => {
  if (document.readyState === 'complete') {
    tagCloud('#tag-cloud-list a',  8 ,  20 );
  }
};

function tagCloud(where, min, max) {
  let iMax = 0;
  let iMin = 0;
  $(where).each(function() {
    let weight = Number($(this).attr("rel"));
    if(iMax < weight) iMax = weight;
    if(iMin > weight || iMin == 0) iMin = weight;
  });
  let step = (max - min)/(iMax - iMin);
  $(where).each(function() {
    let weight = $(this).attr("rel") - iMin;
    $(this).css({"font-size": min + (weight * step) + 'px'});
  });
};
</script>
</div>

      <div class="widget">
    <div class="widget-title H3Tittle"> Categories</div>
    <div class="widget-body">
        <ul class="category-list">
            <li class="category-list-item"><a href="https://gb.ytte.top/categories/bolg/" class="category-list-link">bolg</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://gb.ytte.top/categories/git/" class="category-list-link">git</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://gb.ytte.top/categories/java/" class="category-list-link">java</a><span class="category-list-count">8</span></li>
            <li class="category-list-item"><a href="https://gb.ytte.top/categories/jvm/" class="category-list-link">jvm</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://gb.ytte.top/categories/zookeeper/" class="category-list-link">zookeeper</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://gb.ytte.top/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="category-list-link">数据库</a><span class="category-list-count">3</span></li>
            <li class="category-list-item"><a href="https://gb.ytte.top/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="category-list-link">服务器</a><span class="category-list-count">5</span></li>
            <li class="category-list-item"><a href="https://gb.ytte.top/categories/%E6%9D%82%E9%A1%B9/" class="category-list-link">杂项</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://gb.ytte.top/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" class="category-list-link">消息队列</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://gb.ytte.top/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" class="category-list-link">计算机网络</a><span class="category-list-count">3</span></li>
            <li class="category-list-item"><a href="https://gb.ytte.top/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="category-list-link">设计模式</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://gb.ytte.top/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/" class="category-list-link">面试题</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://gb.ytte.top/categories/%E9%A1%B9%E7%9B%AE/" class="category-list-link">项目</a><span class="category-list-count">1</span></li>
        </ul>
    </div>
</div>
      
<div class="widget">
    <div class="widget-title H3Tittle">Recent Posts</div>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://gb.ytte.top/2022/04/18/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="title">设计模式</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2022-04-18 17:27:43 &#43;0800 CST" itemprop="datePublished">2022-04-18</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://gb.ytte.top/2022/04/15/%E9%9D%A2%E8%AF%95%E9%A2%98/" class="title">面试题</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2022-04-15 16:30:37 &#43;0800 CST" itemprop="datePublished">2022-04-15</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://gb.ytte.top/2022/04/13/springcloud-alibaba/" class="title">SpringCloud alibaba</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2022-04-13 16:02:39 &#43;0800 CST" itemprop="datePublished">2022-04-13</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://gb.ytte.top/2022/04/08/spring/" class="title">Spring</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2022-04-08 10:29:44 &#43;0800 CST" itemprop="datePublished">2022-04-08</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://gb.ytte.top/2022/04/06/springboot/" class="title">SpringBoot</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2022-04-06 16:02:39 &#43;0800 CST" itemprop="datePublished">2022-04-06</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div>
  </div>
</aside>

    
    
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <h4 class="toc-title">Catalogue</h4>
    <nav id="toc" class="js-toc toc">

    </nav>
  </div>
</aside>
<main class="main" role="main"><div class="content">
  <article id="-" class="article article-type-" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      <div itemprop="name" class="H1Tittle">
  <a
    class="article-title"
    href="/2022/04/05/jvm%E4%B8%8A%E7%AF%87/"
    >JVM上篇</a
  >
</div>

      <div class="article-meta">
        
<span class="article-date">
  <i class="icon icon-calendar-check"></i>&nbsp;
<a href="https://gb.ytte.top/2022/04/05/jvm%E4%B8%8A%E7%AF%87/" class="article-date">
  <time datetime="2022-04-05 16:02:39 &#43;0800 CST" itemprop="datePublished">2022-04-05</time>
</a>
</span>
<span class="article-category">
  <i class="icon icon-folder"></i>&nbsp;
  <a class="article-category-link" href="/categories/jvm/"> JVM </a>
</span>  
  <span class="article-tag">
    <i class="icon icon-tags"></i>&nbsp;
    <a class="article-tag-link" href="/tags/jvm/"> JVM </a>
  </span>

		<span class="post-wordcount hidden-xs" itemprop="wordCount">Word Count: 10229 words</span>
		<span class="post-readcount hidden-xs" itemprop="timeRequired">Read Time: 21 minutes </span>
      </div>
    </div>
    <div class="article-entry marked-body js-toc-content" itemprop="articleBody">
      <p>本篇为面试复习总结篇</p>
<p><a href="https://www.processon.com/view/link/61cbc28e5653bb21ce5bb9c8">详情笔记跳转</a>：https://www.processon.com/view/link/61cbc28e5653bb21ce5bb9c8</p>
<h1 id="常用参数">常用参数</h1>
<table>
<thead>
<tr>
<th style="text-align:center">序号</th>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td>-Xss</td>
<td>设置线程的最大栈空间</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td>-Xms</td>
<td>堆空间的起始内存</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td>-Xmx</td>
<td>堆空间的最大内存（超过最大内存将抛出OOM）2和3尽量设置一样</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td>-XX:+PrintGCDetails</td>
<td>可开启打印查看GC细节</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="jvm与java体系结构">JVM与Java体系结构</h1>
<h2 id="1-java虚拟机整体架构祥图">1. Java虚拟机整体架构祥图</h2>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/11/135722620.png" alt=""></p>
<h2 id="2java代码执行过程详图">2.Java代码执行过程详图</h2>
<p><img src="https://blogimg.ytte.top//img-jixiang/20220307170826.png" alt=""></p>
<h1 id="类加载子系统">类加载子系统</h1>
<ul>
<li>负责加载Class文件，Class文件开头有特定标识，魔术，咖啡杯壁</li>
<li>Classloader只负责class文件的加载，至于是否可运行，则由执行引擎决定</li>
</ul>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/11/140107796.png" alt=""></p>
<h2 id="类加载过程">类加载过程</h2>
<ul>
<li><a href="#%E5%8A%A0%E8%BD%BD">加载</a></li>
<li><a href="#%E9%93%BE%E6%8E%A5">链接</a></li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96">初始化</a></li>
</ul>
<h3 id="加载">加载</h3>
<p>加载器分类：</p>
<ol>
<li><a href="#%E5%90%AF%E5%8A%A8%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8">启动类加载器</a></li>
<li><a href="#%E6%89%A9%E5%B1%95%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8">扩展类加载器</a></li>
<li><a href="#%E7%B3%BB%E7%BB%9F%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8">系统类加载器</a></li>
</ol>
<p>功能：</p>
<p>将文件以二进制流形式加载进方法区，生成类元信息。（在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据访问入口）</p>
<h3 id="链接">链接</h3>
<p>功能：</p>
<ol>
<li>
<p>验证</p>
<ul>
<li>文件格式验证（ CA FE BA BE(魔数，Java虚拟机识别)）</li>
<li>元数据</li>
<li>字节码</li>
<li>符号引用</li>
</ul>
</li>
<li>
<p>准备</p>
<ul>
<li><strong>为类变量分配内存</strong>，并且<strong>设置</strong>该类变量的初始值，即<strong>零值</strong> <strong>另一次则是在“初始化”阶段，赋予程序员在代码中定义的初始值。</strong></li>
</ul>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/11/181756072.png" alt=""></p>
<ul>
<li>不包含用final修饰的static（注意：不是static，而是被final修饰的static），因为final在编译的时候就会分配了，准备阶段会显示初始化</li>
<li>不会为实例变量（无static）分配初始化，类变量会分配在方法区中，实例变量会随着对象一起分配到Java堆中</li>
</ul>
</li>
<li>
<p>解析</p>
<p><strong>将常量池内的符号引用转换为直接引用的过程，往往会伴随着JVM在执行完初始化<a href="#%E8%A1%A5%E5%85%85%E8%AF%B4%E6%98%8E">之后再执行</a>。</strong></p>
<ul>
<li>
<p>符号引用就是一组符号来描述引用的目标。符号引用的字面量形式明确定义在Java虚拟机规范的Class文件格式中</p>
</li>
<li>
<p>直接引用就是直接指向目标的指针，相对偏移量或一个间接定位到目标的句柄</p>
</li>
</ul>
</li>
</ol>
<h3 id="初始化">初始化</h3>
<ul>
<li>
<p>初始化阶段是执行类构造器方法<!-- raw HTML omitted -->()的过程 <strong>为类变量</strong>赋予程序员在代码中定义的初始值。</p>
</li>
<li>
<p><strong>如果没有类变量和静态代码块，也不会有clinit</strong></p>
</li>
<li>
<p><!-- raw HTML omitted -->()不同于类的构造器（构造器是虚拟机视角下的<!-- raw HTML omitted -->()）</p>
</li>
<li>
<p>若该类具有父类，JVM会保证子类的<!-- raw HTML omitted -->()执行前，父类的<!-- raw HTML omitted -->()已经执行完毕</p>
</li>
<li>
<p>虚拟机必须保证一个类的<!-- raw HTML omitted -->()方法在多线程下被同步加</p>
</li>
</ul>
<h3 id="补充说明">补充说明</h3>
<ul>
<li><!-- raw HTML omitted -->（IP）<!-- raw HTML omitted -->解析阶段不一定，在某些情况下可以在初始化阶段之后再开始，为了支持Java语言的运行时绑定特性（也称为动态绑定或晚期绑定）</li>
<li>Java虚拟机规范严格规定了，有且只有六种情况，必须立即对类进行初始化（主动使用）
<ol>
<li>遇到<strong>new,getstatic，putstatic或invokestatic</strong>这四条字节码指令时。</li>
<li>对类型进行<strong>反射调用</strong>，如果类型没有经过初始化，则需要触发初始化</li>
<li>初始化类的时候，发现<strong>父类没有初始化</strong>，则先触发父类初始化</li>
<li>虚拟机启动时，用户需要<strong>指定</strong>一个要执行的<strong>主类</strong>（包含main方法的那个类），虚拟机会初始化这个主类</li>
<li>只用JDK7中新加入的动态语言支持，如果一个java.lang.invoke.MethodHandler实例最后的解析结果为REF_getStatic,REF_putStatic,REF_invokeStatic，REF_newInvokeSpecial四种类型的方法句柄，并且这个方法对应的类没有进行初始化，则先触发其初始化</li>
<li>当一个接口中定了JDK8新加入的默认方法时，如果这个接口的实现类发生了初始化，要先将接口进行初始化</li>
</ol>
</li>
</ul>
<p><strong>除了以上几种情况，其他使用类的方式被看做是对类的被动使用，都不会导致类的初始化</strong></p>
<h3 id="类加载器的分类">类加载器的分类</h3>
<p>jvm虚拟机规范中定义：除了引导类（启动类）加载器以外都是自定义加载器。但是我们通常认定除了启动类扩展类系统类加载器以外的是自定义加载器。</p>
<p>对于用户来说定义器来说，默认使用系统类加载器进行加载</p>
<p>Java的核心类库，使用引导类加载器进行加载</p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/12/105818308.png" alt=""></p>
<h4 id="代码获取类加载器">代码获取类加载器</h4>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/12/110204210.png" alt=""></p>
<h4 id="启动类加载器">启动类加载器</h4>
<ul>
<li>
<p><strong>用来加载Java核心类库，rt.jar,resources.jar,sun.boot.class.path路径下的内容</strong></p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/12/110346119.png" alt=""></p>
</li>
<li>
<p>并不继承java.lang.ClassLoader，没有父加载器</p>
</li>
<li>
<p><strong>Bootstrap启动类加载器只加载包名为java\javax\sun等开头的类</strong></p>
<p>​	所以自定义String不会覆盖java 自身的String类</p>
</li>
</ul>
<h4 id="扩展类加载器">扩展类加载器</h4>
<ul>
<li>派生于ClassLoader类，父类加载器为启动类加载器。</li>
</ul>
<h4 id="系统类加载器">系统类加载器</h4>
<ul>
<li>派生于ClassLoader类，父类加载器为扩展类加载器。</li>
<li>负责加载环境变量classpath或系统属性java.class.path指定路径下的类库。</li>
<li>该类加载器是程序中默认的类加载器，Java应用的类都是由它来完成加载。</li>
</ul>
<h4 id="自定义加载器">自定义加载器</h4>
<ul>
<li>
<p><strong>为什么要用自定义类加载器</strong></p>
<ul>
<li>
<p><strong>隔离加载类</strong></p>
<p>例如使中间件的Jar包与应用程序Jar包不冲突</p>
</li>
<li>
<p><strong>修改类加载的方式</strong></p>
</li>
<li>
<p><strong>扩展加载源</strong></p>
</li>
<li>
<p><strong>防止源码泄露</strong></p>
<p>对字节码进行加密，自定义类加载器实现解密</p>
</li>
</ul>
</li>
</ul>
<h3 id="加载过程中的双亲委派机制">加载过程中的双亲委派机制</h3>
<p><strong>图示</strong>：</p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/12/111032995.png" alt=""></p>
<p><strong>概念</strong>：</p>
<p>Java虚拟机对Class文件采用的是按需加载。加载class文件时，Java虚拟机使用的是双亲委派模式。</p>
<ol>
<li>
<p>如果一个类加载器收到了类加载请求，它并不会自己先去加载。而是把这个请求委托给父类的加载器去执行。</p>
</li>
<li>
<p>如果父类加载器还存在其父类加载器，则进一步向上委托，依次递归，请求最终将达到顶层的启动类加载器。</p>
</li>
<li>
<p>如果父类的加载器可以完成类加载任务，就成功返回，倘若父类加载器无法完成此加载任务，子加载器才会尝试自己去加载，依次类推，这就是双亲委派模式。</p>
</li>
</ol>
<p><strong>例子</strong>：</p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/12/111745320.png" alt=""></p>
<ul>
<li>
<p>比如在使用第三方包jdbc。jar包时，其中的spi核心接口类在rt.jar包中，rt.jar包由引导类加载器加载</p>
</li>
<li>
<p>而rt.jar接口的实现类在jdbc.jar包中，引导类加载器就会反向委托线程上下文类加载器（也就是系统类加载器）去加载</p>
</li>
</ul>
<p><strong>优势</strong>：</p>
<ul>
<li>
<p>避免类的重复加载</p>
</li>
<li>
<p>保护程序安全，防止核心API被篡改</p>
<p>​	java默认禁止自定义类放入引导类加载器加载的包下（java，javax等）默认自定义类没有这个权限，这也是为了引导类加载器	的安全考虑。</p>
</li>
</ul>
<p><strong>补充</strong>：</p>
<ul>
<li>
<p>沙箱安全机制就是如此。从而保证对Java核心源代码的保护。</p>
</li>
<li>
<p>在JVM中表示两个class对象，是否为同一个类存在两个必要条件</p>
<ul>
<li>类的完整类名必须一致，包括包名</li>
<li>加载这个类的ClassLoader必须相同</li>
</ul>
<p><strong>换句话说,在JⅥ中,即使这两个类对象(class对象)来源同一个Class文件,被同一个虚拟机所加载,但只要加载它们的Classloader实例对象不同,那么这两个类对象也是不相等的。</strong></p>
</li>
<li>
<p><strong>对类加载器的引用：JVM必须知道一个类型哪个加载器加载的。如果是用户类加载器加载的，那么jvm会把class字节码文件被加载到内存的方法区当中，除此之外，JVM会将这个类加载器的一个引用作为类型信息的一部分，这个类的类加载器信息也会被保存在方法区中。当解析一个类型到另一个类型的引用的时候， jvm需要保证这两个类型的类加载器相同。</strong></p>
</li>
</ul>
<h1 id="运行时数据区">运行时数据区</h1>
<h2 id="概述">概述</h2>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/12/113423547.png" alt=""></p>
<p>Java虚拟机定义了若干种程序运行期间会使用到的运行时数据区</p>
<ul>
<li>
<p>其中有一些会随着虚拟机启动而创建，随着虚拟机退出而销毁。</p>
</li>
<li>
<p>另外一些则是与线程一一对应的，这些与线程对应的数据区域会随着线程开始和结束而创建和销毁。</p>
</li>
</ul>
<ol>
<li>
<p>每个线程各自独享：独立包括程序计数器、栈、本地栈。</p>
</li>
<li>
<p>线程间共享：堆、堆外内存（永久代或元空间、代码缓存）</p>
</li>
<li>
<p>每个JVM只有一个runtime实例（runtime实例是单例的），所以才能多个线程之间共享，这个实例即运行时环境（java虚拟机运行时数据区）。</p>
</li>
<li>
<p>垃圾回收主要针对堆空间（95%）的回收和方法区（5%）jdk8中方法区变成了元数据区,使用的是本地内存（空间较小）但也会在溢出所以也要回收一下。pc计数器，栈，本地栈都是栈，回收操作顶多是入栈出栈。</p>
</li>
<li>
<p>在虚拟机栈中大都是对堆中的引用，具体存储的信息都是在堆当中存储。</p>
</li>
<li>
<p>jvm里每个线程都与操作系统的本地线程直接映射，二者生命周期相同。</p>
<p>主要线程有：</p>
<ul>
<li><strong>虚拟机线程</strong>：这种线程的操作是需要JVM达到安全点才会出现。这些操作必须在不 同的线程中发生的原因是他们都需要JVM达到安全点，这样堆才不会变化。这种线程的执行类型包括&quot;stop-the-world&quot;的垃圾收集，线程栈收集，线程挂起以及偏向锁撤销。</li>
<li><strong>周期任务线程</strong>：这种线程是时间周期事件的体现（比如中断），他们一般用于周期性 操作的调度执行。</li>
<li><strong>GC线程</strong>：这种线程对在JVM里不同种类的垃圾收集行为提供了支持。</li>
<li><strong>编译线程</strong>：这种线程在运行时会将字节码编译成到本地代码。</li>
<li><strong>信号调度线程</strong>：这种线程接收信号并发送给JVM，在它内部通过调用适当的方法进行处理。</li>
</ul>
</li>
</ol>
<h2 id="程序计数器pc寄存器">程序计数器（PC寄存器）</h2>
<ul>
<li>
<p>运行时数据区中唯一不会出现OOM的区域，没有垃圾回收</p>
</li>
<li>
<p>如果线程执行的Java方法，则计数器记录正在执行的虚拟机字节码的下一条指令的地址，如果存在线程切换，能将程序代码在以后恢复到争取的位置。</p>
</li>
<li>
<p>如果正在执行的本地方法，这个计数器值则应为空。（undefined）</p>
</li>
</ul>
<h2 id="虚拟机栈">虚拟机栈</h2>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/11/135722620.png" alt=""></p>
<p>内存中的栈与堆：栈是运行时的单位，而堆是存储的单位，栈解决程序如何执行，如何处理数据。堆解决的是数据存储问题，即数据怎么放，放在哪里。</p>
<h3 id="概念">概念</h3>
<ul>
<li>
<p>虚拟机栈的生命周期和线程的一致</p>
</li>
<li>
<p>主管Java程序的运行，保存方法的局部变量（8种基本数据类型，对象的引用地址），部分结果，并参与方法的调用和返回。</p>
</li>
</ul>
<h3 id="优点">优点</h3>
<ol>
<li>快速有效的存储方式，访问速度仅次于程序计数器</li>
<li>栈不存在垃圾回收，但是存在OOM</li>
<li>Java栈大小是动态或者固定不变的。
<ul>
<li>如果是动态扩展，无法申请到足够内存OOM</li>
<li>如果是固定，即在线程被创建以后就被固定下来，线程请求的栈容量超过固定值，则StackOverflowError</li>
</ul>
</li>
<li>使用<code>-Xss</code> ，设置线程的最大栈空间。例如：-Xss1m、-Xss、1024k、-Xss1048576</li>
</ol>
<h3 id="存储单位">存储单位</h3>
<ol>
<li>每个线程都有自己的栈，栈中的数据以栈帧格式存储，一个方法一个栈帧。</li>
<li>栈帧是一个内存区块，是一个数据集，维系着方法执行过程中的各个数据信息</li>
<li>执行引擎运行的所有字节码指令只针对当前栈帧进行操作，当前在执行的方法就是当前帧。</li>
<li>先进后出，后进先出，先执行最上方的方法（栈帧）。期间如果调用了其他方法，对应的方法栈帧会被创建放在栈顶，成为新的当前帧。</li>
</ol>
<h3 id="运行原理">运行原理</h3>
<ol>
<li><strong>不同线程中包含的栈帧不允许存在相互引用。</strong></li>
<li>Java方法有两种返回方式（调用了其他方法结束返回）
<ul>
<li>一种是正常的函数返回，使用return指令</li>
<li>另外一种是抛出异常，不管哪种方式，都会导致栈帧被弹出</li>
</ul>
</li>
</ol>
<h3 id="内部结构">内部结构</h3>
<ol>
<li><a href="#%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E8%A1%A8">局部变量表</a></li>
<li><a href="#%E6%93%8D%E4%BD%9C%E6%95%B0%E6%A0%88">操作数栈</a></li>
<li><a href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5">动态链接</a></li>
<li><a href="#%E6%96%B9%E6%B3%95%E8%BF%94%E5%9B%9E%E5%9C%B0%E5%9D%80">方法返回地址</a></li>
<li><a href="#%E9%99%84%E5%8A%A0%E4%BF%A1%E6%81%AF">附加信息</a></li>
<li><a href="#%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8">方法的调用</a></li>
</ol>
<h4 id="局部变量表">局部变量表</h4>
<p>————概念————：</p>
<ol>
<li>定义为一个数字数组，主要用于<strong>存储方法参数</strong>、定义在方法体内部的<strong>局部变量</strong>、<strong>数据类型信息</strong>（基本数据类型（8种），引用类型（reference）,return address 类型）。
<ul>
<li>基本类型变量存储值。</li>
<li>引用类型存储指向堆空间的地址。</li>
</ul>
</li>
<li>局部变量表建立在线程的栈上，是线程私有的，也是方法私有的（一个栈帧一个局部变量表，生命周期跟随方法），因此不存在数据安全问题。</li>
<li>局部变量表容量大小是在编译期确定下来的。</li>
<li>最基本的存储单元是slot。32位为一个slot，64位类型（long和double）占用两个slot。</li>
</ol>
<p>————关于Slot————：</p>
<ol>
<li>
<p>JVM虚拟机会为局部变量表中的每个Slot都分配一个访问索引，通过这个索引即可成功访问到局部变量表中指定的局部变量值</p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/12/181550684.png" alt=""></p>
</li>
<li>
<p><strong>如果当前帧是由构造方法或者实例方法创建的（非静态方法），那么该对象引用this，会存放在index为0的slot处，其余的参数表顺序继续排列</strong></p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/12/181527771.png" alt=""></p>
</li>
<li>
<p><strong>局部变量表中的槽位是可以重复的</strong>，如果一个局部变量过了其作用域，那么其作用域之后申明的新的局部变量就有可能会复用过期局部变量的槽位，从而达到节省资源的目的。</p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/12/181733808.png" alt=""></p>
</li>
</ol>
<p>————<strong>静态变量与局部变量对比及小结</strong>————：</p>
<p>变量按照数据类型分类：</p>
<ol>
<li>基本数据类型</li>
<li>引用数据类型</li>
</ol>
<p>变量按照声明的位置：</p>
<ol>
<li>
<p>成员变量，在使用前经历过初始化过程</p>
<ul>
<li>
<p>类变量（静态变量）</p>
<p>链接的准备阶段给类变量默认赋值，初始化阶段显示赋值，即静态代码块赋值</p>
</li>
<li>
<p>实例变量（非静态变量）</p>
<p>随着对象的创建，会在堆空间分配实例变量空间，并进行默认赋值</p>
</li>
</ul>
</li>
<li>
<p>局部变量</p>
<p>在使用前，必须进显式赋值，否则编译不通过</p>
</li>
</ol>
<p>————补充————：</p>
<ol>
<li>在栈帧中，与性能调优关系最密切的部分，就是局部变量表，方法执行时，虚拟机使用局部变量表完成方法的传递。</li>
<li>只要被局部变量表中直接或间接引用的对象都不会被回收，所以局部变量表中的变量也是重要的垃圾回收根节点。</li>
</ol>
<p>2022-4-12 21:47:06</p>
<hr>
<h4 id="操作数栈">操作数栈</h4>
<p>Java虚拟机的解释引擎是基于栈的执行引擎，其中栈就是操作数栈</p>
<p>————概念————：</p>
<ul>
<li>当一个方法刚开始执行的时候，一个新的栈帧也会随之被创建出来，这个方法的操作数栈是空的</li>
<li>每一个操作数栈会拥有一个明确的栈深度，用于存储数值，<strong>最大深度在编译期就定义好</strong></li>
<li>栈中，32bit类型占用一个栈单位深度，64bit类型占用两个栈单位深度</li>
<li>操作数栈并非采用访问索引方式进行数据访问，而是只能通过标准的入栈、出栈操作完成一次数据访问</li>
</ul>
<p>————作用————：</p>
<ul>
<li>
<p>如果被调用方法带有返回值的话，其返回值将会被压入当前栈帧的操作数栈中，并更新程序计数器中<strong>下一条需要执行的字节码指令地址</strong>。</p>
</li>
<li>
<p>主要用于保存计算过程的中间结果，同时作为计算过程中变量临时的存储空间</p>
</li>
</ul>
<p>————栈顶缓存技术————：</p>
<p>由于操作数是存储在内存中，频繁的进行内存读写操作影响执行速度，将栈顶元素全部缓存到物理CPU的寄存器中，依此降低对内存的读写次数，提升执行引擎的执行效率。</p>
<h4 id="动态链接">动态链接</h4>
<p>视频 p55 ———— <a href="https://www.bilibili.com/video/BV1PJ411n7xZ?p=55">尚硅谷</a></p>
<p>————概念————：</p>
<ul>
<li><strong>是指向常量池的方法引用（动态链接保存这个引用，方便方法字节码访问常量池）</strong></li>
<li>每一个栈帧内部都包含一个指向运行时常量池中，该帧所属方法的引用</li>
<li>描述一个方法调用了另外的其他方法时，就是通过常量池中指向方法的符号引用来表示的。在java源文件被编译成字节码文件中时，所有的变量和方法引用都作为<strong>符号引用（字面量序号）</strong>，保存在class文件的常量池中。</li>
</ul>
<p>————作用————：</p>
<ul>
<li>动态链接的作用就是为了将所有的变量和方法的符号引用转换为常量池中调用方法的<strong>直接引用（直接引用地址）</strong>。</li>
</ul>
<p>————补充————：</p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/13/120817044.png" alt=""></p>
<p><strong>左边是符号引用#1等等。=右边的是直接引用。有时也会符号A引用符号B，然后符号引用B再=直接饮用</strong></p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/13/121503838.png" alt=""></p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/13/121723296.png" alt=""></p>
<h5 id="常量池运行时常量池">常量池、运行时常量池：</h5>
<p><strong>常量池在字节码文件中，运行时常量池，在运行时的方法区中</strong></p>
<p><strong>在常亮池当中往往会有（）V，是无返回值类型，同时也是无参数的，这个()V往往可以被多次引用</strong></p>
<h5 id="为什么需要常量池呢">为什么需要常量池呢？</h5>
<p><strong>像system，父类，string等等这些类不能都写在该类中，所以采用常量池来引用。就是为了提供一些符号和常量，便于指令的识别与引用，减小编译文件的大小。</strong></p>
<p>invokedynamic指令：</p>
<p>todo</p>
<h4 id="方法返回地址">方法返回地址</h4>
<ul>
<li>
<p><strong>存放调用该方法的pc寄存器的值</strong></p>
<p>就是讲pc寄存器里存放的下一条指令的地址当做返回，交给执行引擎，告诉他下一条指令执行什么</p>
</li>
<li>
<p><strong>异常退出的，返回地址是通过异常表来确定</strong>。正常完成出口和异常完成出口的区别在于：<strong>通过异常完成出口退出的不会给他的上层调用者产生任何的返回值</strong></p>
</li>
</ul>
<p>本质上，方法的退出就是当前栈帧出栈的过程。此时需要恢复上层方法的局部变量表，操作数栈，将返回值压入调用者栈帧的操作数栈，设置PC寄存器值等，让调用者方法继续执行下去。</p>
<h4 id="附加信息">附加信息</h4>
<p>允许携带与Java虚拟机实现相关的一些附加信息，例如对程序调试提供支持的信息。不确定有，可选情况。</p>
<h4 id="方法的调用">方法的调用</h4>
<h5 id="静态链接">静态链接</h5>
<p>编译期期间，将调用方的符号引用转为直接引用的过程称为静态链接（运行期间保持不变）</p>
<h5 id="动态的链接">动态的链接</h5>
<p>如果被调用的方法无法再编译期被确定下来，只能在运行期将调用的方法的符号引用转为直接引用，这种引用转换过程具备动态性，因此被称为动态链接</p>
<h5 id="方法的绑定">方法的绑定</h5>
<p>绑定是一个字段、方法、或者类在符号引用被替换为直接引用的过程。仅仅发生一次。</p>
<ul>
<li>
<p>早期绑定</p>
<p>被调用的目标方法如果再编译期可知，且运行期保持不变</p>
</li>
<li>
<p>晚期绑定</p>
<p>被调用的方法在编译期无法被确定，只能够在程序运行期根据实际的类型绑定相关的方法。</p>
</li>
</ul>
<h5 id="虚方法和非虚方法">虚方法和非虚方法</h5>
<p>Java中任何一个普通方法都具备虚函数的特征（运行期确认，具备晚期绑定的特点），C++中则使用关键字virtual来显式定义。</p>
<p>如果在java程序中，不希望某个方法拥有虚函数的特征，则可以使用关键字final来标记这个方法</p>
<ol>
<li>非虚方法</li>
</ol>
<ul>
<li>
<p>如果方法在编译期就确定了具体的调用版本，则这个版本在运行时是不可变的。这样的方法称为非虚方法</p>
</li>
<li>
<p>**静态方法，私有方法，final方法，实例构造器，父类方法都是非虚方法（子类重写后通过super调用父类方法，这就是确定下来的。）**对应着<a href="#%E5%A4%9A%E6%80%81">多态</a>图中所述。</p>
</li>
</ul>
<ol start="2">
<li>虚方法</li>
</ol>
<p>其他方法称为虚方法</p>
<p>如果有一个方法，子类没有重写对应父类方法，但是在子类直接调用了对应父类方法，没有加上supe。这样会被认定为调用自己的方法（但是子类并没有对应方法）。所以不能确定该方法。因此只能在运行期间才能确定该方法，所以标注为invokevirtual虚方法。</p>
<ol start="3">
<li>虚——方法表</li>
</ol>
<p>面向对象的编程中，会很频繁的使用动态分配，如果每次动态分配的过程都要重新在类的方法元数据中搜索合适的目标的话，就可能影响到执行效率，因此为了提高性能，<strong>JVM采用在类的方法区建立一个虚方法表，使用索引表来代替查找</strong></p>
<p><strong>每个类都有一个虚方法表，表中存放着各个方法的实际入口</strong></p>
<p><strong>虚方法表会在类加载的链接阶段被创建，并开始初始化，类的变量初始值准备完成之后，JVM会把该类的方法也初始化完毕</strong>。</p>
<h5 id="多态">多态</h5>
<ol>
<li>当使用多态方式调用方法时，首先检查父类中是否有该方法</li>
</ol>
<ul>
<li>如果没有，则编译错误；</li>
<li>如果有，再去调用子类的同名方法</li>
</ul>
<ol start="2">
<li>多态的好处</li>
</ol>
<ul>
<li>可以使程序有良好的扩展，并可以对所有类的对象进行通用处理</li>
</ul>
<p>如果不采用多态的形式，Show方法参数类型就会有两种，这时候就需要重载show方法才能分别接受Cat和dog类型的参数。</p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/13/164021953.png" alt=""></p>
<h5 id="方法调用指令">方法调用指令</h5>
<p>todo</p>
<h5 id="方法重写的本质">方法重写的本质</h5>
<p>todo</p>
<h2 id="堆">堆</h2>
<h3 id="概述-1">概述</h3>
<ul>
<li>一个JVM实例只存在一个堆内存</li>
<li>Java堆区在JVM启动的时候即被创建，其空间大小也就确认了。堆内存的大小是可调节的。</li>
<li>堆可以处于物理上不连续的内存空间中，但在逻辑上它应该被视为连续的。</li>
<li>所有的线程共享Java堆，在这里还可以划分线程私有的缓冲区（TLAB）。</li>
<li>所有的对象实例都在堆分配内存。</li>
<li>方法结束后，堆中的对象不会马上被移除，仅仅在垃圾收集的时候才会被移除。</li>
<li>堆是GC执行垃圾回收的重点区域。</li>
<li>gc线程开始即表明用户线程需要暂停（Stop the world）。</li>
<li>现代垃圾收集器大部分都基于分代收集理论设计。</li>
</ul>
<h4 id="堆空间细分为">堆空间细分为：</h4>
<ol>
<li>约定</li>
</ol>
<ul>
<li>新生区=新生代=年轻代</li>
<li>养老区=老年区=老年代</li>
<li>永久区=永久代（是方法区 的实现）</li>
</ul>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/13/173758006.png" alt=""></p>
<ol start="2">
<li>Java7及之前</li>
</ol>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/13/173647293.png" alt=""></p>
<ol start="3">
<li>Java8及之后</li>
</ol>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/13/173727046.png" alt=""></p>
<p><strong>-XX:+PrintGCDetails 可开启打印查看方法区实现</strong></p>
<h3 id="设置堆内存的大小与oom">设置堆内存的大小与OOM</h3>
<h4 id="参数">参数</h4>
<ol>
<li><strong>-Xms ：表示堆空间的起始内存。</strong></li>
<li><strong>-Xmx：表示堆空间的最大内存，超过最大内存将抛出OOM。</strong></li>
</ol>
<p><strong>通常将-Xms和-Xmx两个参数配置相同的值，其目的是为了能够在java垃圾会后清理完堆区后，不需要重新分隔计算堆区的大小，从而提高性能</strong></p>
<p>默认情况下初始内存大小为物理电脑内存大小/64，最大内存大小为物理电脑内存1/4</p>
<ol start="3">
<li>查看堆参数</li>
</ol>
<ul>
<li>
<p>cmd命令</p>
<ul>
<li>jps命令（查看当前程序运行的进程）</li>
<li>jstat -gc 进程号（查看JVM在gc时的统计信息）</li>
</ul>
</li>
<li>
<p>加运行参数</p>
</li>
</ul>
<p>-XX:+PrintGCDetails</p>
<h3 id="年轻代与老年代">年轻代与老年代</h3>
<ol>
<li>一般只能使用Eden区 和一个Survivor区，两个Survivor区只能使用其一。</li>
<li>新生代与老年代空间默认比例1:2</li>
<li>在HotSpot中，Eden空间和另外两个Survivor空间缺省所占的比例是：8:1:1（实际是6:1:1，因为有自适应机制）</li>
<li>几乎所有的Java对象都是在Eden区被new出来的。Eden放不了的大对象，直接会进入老年代。</li>
<li>新生代80%的对象都是朝生夕死</li>
</ol>
<h3 id="图解对象分配一般过程">图解对象分配一般过程</h3>
<ol>
<li>
<p>new的对象在为超过Eden区内存大小的情况下，先放在Eden区。</p>
</li>
<li>
<p>当创建新对象，<strong>Eden空间填满时，会触发Minor GC</strong>，将Eden和幸存者区中不再被其他对象引用的对象进行销毁。
<strong>幸存者区满的时候不会触发minorGC，但是minorGC会回收幸存者区</strong>。</p>
</li>
<li>
<p>minorGC将Eden中剩余的对象移到幸存者0区。再加载新的对象放到Eden区</p>
</li>
<li>
<p>再次触发垃圾回收，此时上次幸存者下来的，在幸存者0区的，如果没有回收，就会放到幸存者1区。</p>
</li>
<li>
<p>再次经历垃圾回收，又会将幸存者重新放回幸存者0区，依次类推。</p>
</li>
<li>
<p>设置一个年龄计数器参数，默认是15次，超过15次minorGC，则会将幸存者区幸存下来的转去老年区.</p>
</li>
</ol>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/13/180540541.png" alt=""></p>
<ol start="7">
<li>总结：</li>
</ol>
<ul>
<li>
<p>针对幸存者s0，s1区的总结：复制之后有交换，谁空谁是to。</p>
</li>
<li>
<p>频繁在新生区收集，很少在养老区收集，几乎不在永久区/元空间搜集。</p>
</li>
<li>
<p>直接进入老年的几种可能性：</p>
<ul>
<li>
<p>对象实例占用内存太大，新生代放不下，直接进入老年代。</p>
</li>
<li>
<p>幸存者区中未满15阈值时或者幸存者区满时都是有可能直接进入老年代。</p>
</li>
</ul>
</li>
</ul>
<h3 id="对象分配特殊过程">对象分配特殊过程</h3>
<ol>
<li>触发YGC，幸存者区就会进行回收，不会主动进行回收。</li>
</ol>
<p>超大对象eden放不下，就要看Old区大小是否可以放下，old区也放不下，需要FullGC（MajorGC），再者就OOM。这两GC概念还是有区别的。<a href="#%E4%B8%89%E4%B8%AAGC">下面详解</a></p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/13/180814237.png" alt=""></p>
<h3 id="三个gc">三个GC</h3>
<ol>
<li><a href="#MinorGC">MinorGC</a></li>
<li><a href="#MajorGC">MajorGC</a></li>
<li><a href="#FullGC">FullGC</a></li>
</ol>
<p>（性能调用主要针对MajorFC和FullGC,因为二者所需要暂停用户线程的时间最长，所以调优目的就是使二者的发生次数减少）</p>
<h4 id="不同回收器分类">不同回收器分类</h4>
<p><img src="https://blogimg.ytte.top/img-jixiang/2022/04/13/181522134.png" alt=""></p>
<h4 id="minorgc">MinorGC</h4>
<p>新生代收集</p>
<p><strong>Eden空间填满时，会触发Minor GC</strong>，将Eden和幸存者区中不再被其他对象引用的对象进行销毁。<strong>幸存者区满的时候不会触发minorGC，但是minorGC会回收幸存者区</strong>。</p>
<h4 id="majorgc">MajorGC</h4>
<p>老年代收集</p>
<ol>
<li>指发生在老年代的GC，对象从老年代消失，我们说“MajorGC”“FullGC”发生了</li>
<li>出现了MajorGC，经常会伴随至少一次MinorGC；也就是老年代空间不足，会先尝试触发MinorGC，如果之后空间还不足，则触发MajorGC。</li>
<li>如果MajorGC后，内存还不足，就报OOM了</li>
</ol>
<h4 id="fullgc">FullGC</h4>
<p><strong>整堆收集：收集整个Java堆和方法区的垃圾收集</strong></p>
<ol>
<li>
<p>调用System.gc()时，系统建议执行FullGC，但是不必然执行。</p>
</li>
<li>
<p>老年代空间不足。</p>
</li>
<li>
<p>方法区空间（非堆）不足。</p>
</li>
<li>
<p>通过MinorGC后进入老年代的平均大小，大于老年代的可用内存</p>
</li>
<li>
<p>由Eden区，Survivor 0区向Survivor 1区复制时，对象的大小大于To可用内存，则把改对象转存到老年代，且老年代的可用内存小于该对象的大小。</p>
</li>
<li>
<p>FullGC是开发或调优中尽量要避免的，这样暂停时间会短一些。</p>
</li>
</ol>
<h3 id="内存分配策略">内存分配策略</h3>
<ol>
<li>如果对象在Eden出生并经过第一次MinorGC后仍然存活，并且能被Survivor区容纳，则被移动到Survivor空间中，并将对象年龄设置为1，对象再Survivor区每熬过一次MinorGC，年龄就+1，当年龄增加到一定程度（默认为15，不同Jvm，GC都所有不同）时，就会被晋升到老年代中。</li>
<li>优先分配到Eden</li>
<li>大对象直接分配到老年代</li>
<li>长期存活的对象分配到老年代</li>
<li><strong>动态对象年龄分配</strong>。如果Survivor区中相同年龄的所有对象大小的总和大于Survivor空间的一半，年龄大于或等于该年龄的对象可以直接进入老年代，无需等到MaxTenuringThreshold中要求的年龄。</li>
<li><strong>空间分配担保</strong>
<ul>
<li>在发生Minor GC之前，虚拟机会检查老年代最大可用的连续空间，是否大于新生代所有对象的总空间。</li>
<li>jdk6update24之后，HandlePromotionFailure参数设置成了true，且不能改变。</li>
<li><strong>只要老年代的连续空间大于新生代对象总大小，或者历次晋升的平均大小，就会进行MinorGC，否则进行FullGC。</strong></li>
</ul>
</li>
</ol>
<h3 id="为对象分配内存tlab">为对象分配内存TLAB</h3>
<ol>
<li>概念</li>
</ol>
<p>Thread Local Allocation Buffer</p>
<p>堆区是线程共享区域，任何线程都可以访问到堆区的共享数据。由于对象实例的创建在JVM中非常频繁，因此在并发环境下从堆区中划分内存空间是线程不安全的。为避免多个线程操作同一地址，需要使用加锁等机制，进而影响分配速度</p>
<p>从内存模型而不是垃圾收集的角度，<strong>对Eden区域进行划分，JVM为每个线程分配了一个私有缓存区域，包含在Eden空间中</strong>。多线程同时分配内存时，使用TLAB可以避免一系列的非线程安全问题（只能解决一部分问题，因为<strong>TLAB只占用了1%Eden空间</strong>，一旦对象过大就只能放在Eden中）， 同时还能够提升内存分配的吞吐量，因此我们将这种内存分配方式成为<strong>快速分配策略</strong>。</p>
<p>默认情况下，TLAB空间内存非常小，仅占有整个Eden空间的1%，通过-XX:TLABWasteTargetPercent设置TLAB空间所占用Eden空间的百分比大小。</p>
<p>一旦对象在TLAB空间分配内存失败，JVM就会尝试通过使用加锁机制确保数据操作的原子性，从而直接在Eden空间中分配内存</p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/14/161803558.png" alt=""></p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/14/161938733.png" alt=""></p>
<p>2022-4-14</p>
<hr>
<h3 id="堆是分配对象的唯一选择吗">堆是分配对象的唯一选择吗</h3>
<p>需要注意的是，只有服务器在server模式下才能使用逃逸分析，一般64位系统默认开启逃逸分析其次 HotSpot中并未没有应用栈上分配，只是进行了标量替换（进行了标量替换，自然就没有了聚合量，也自然就没有new对象，所以就没有对象实例的创建就不会放在堆空间中）</p>
<h4 id="逃逸分析">逃逸分析</h4>
<p>当一个对象在方法中定义后，对象只在方法内部消费掉，则认为没有发生逃逸；如果没有被消费掉，被外部方法引用了，则认为发生逃逸，例如作为调用参数传递到其他地方中：</p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/14/163024990.png" alt=""></p>
<h3 id="堆总结">堆总结</h3>
<ol>
<li>新生代中Eden区过大，survivor区过小的情况</li>
</ol>
<p>会使得MinorGC后存留的大部分对象不能进入survivor区进行年龄计数，直接进入了老年代，导致内存分配策略失效（年龄计数失效）影响性能。</p>
<ol start="2">
<li>新生代中Eden区过小，survivor区过大的情况</li>
</ol>
<p>这种情况会使得频繁进行MinorGC，性能也会大大下降。</p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/16/104729389.png" alt=""></p>
<p><img src="https://blogimg.ytte.top//img-jixiang/2022/04/17/184339119.png" alt=""></p>
    </div>
    <div class="article-footer">
<blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    <li class="post-copyright-link hidden-xs">
      <strong>Permalink: </strong>
      <a href="https://gb.ytte.top/2022/04/05/jvm%E4%B8%8A%E7%AF%87/" title="JVM上篇" target="_blank" rel="external">https://gb.ytte.top/2022/04/05/jvm%E4%B8%8A%E7%AF%87/</a>
    </li>
    <li class="post-copyright-license">
      <strong>License: </strong>
        <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN</a>
    </li>
  </ul>
</blockquote>

<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/YTTE-jx" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://gb.ytte.top/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <div class="media-heading H3Tittle"><a href="https://github.com/YTTE-jx" target="_blank"><span class="text-dark">YTTE</span><small class="ml-1x">努力奋斗，不负韶华。</small></a></div>
        <div>Good Good Study, Day Day Up~</div>
      </div>
    </figure>
  </div>
</div>

    </div>
  </article>
</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="https://gb.ytte.top/2022/04/05/spring-mvc/" title="Spring Mvc"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;Older</span></a>
            </li>
            <li class="next">
                <a href="https://gb.ytte.top/2022/04/06/springboot/"
                    title="SpringBoot"><span>Newer&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
            <li class="toggle-toc">
                <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false"
                    title="Catalogue" role="button">
                    <span>[&nbsp;</span><span>Catalogue</span>
                    <i class="text-collapsed icon icon-anchor"></i>
                    <i class="text-in icon icon-close"></i>
                    <span>]</span>
                </a>
            </li>
        </ul>
        <div class="bar-right">
            <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter"
                data-mobile-sites="weibo,qq,qzone"></div>
        </div>
    </div>
</nav>


</main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
<ul class="social-links">
    <li><a href="https://github.com/YTTE-jx" target="_blank" title="github" data-toggle=tooltip data-placement=top >
            <i class="icon icon-github"></i></a></li>
    <li><a href="https://gb.ytte.top/index.xml" target="_blank" title="rss" data-toggle=tooltip data-placement=top >
            <i class="icon icon-rss"></i></a></li>
</ul>
  <div class="copyright">
    &copy;2022  -
    2022
    <div class="publishby">
        Theme by <a href="https://github.com/xiaoheiAh" target="_blank"> xiaoheiAh </a>base on<a href="https://github.com/xiaoheiAh/hugo-theme-pure" target="_blank"> pure</a>.
    </div>
    
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/python.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/javascript.min.js" defer></script><script>
    hljs.configure({
        tabReplace: '    ', 
        classPrefix: ''     
        
    })
    hljs.initHighlightingOnLoad();
</script>
<script src="https://gb.ytte.top/js/application.min.e720b935330b2a176cfb4b8bd9a6cc632caf6b752f94e87c62152a9557ff6d15.js"></script>
<script src="https://gb.ytte.top/js/plugin.min.334875d4d4a72afb866e446df61b5f4bf1f0a516d1303166f52f7804d17ef3ab.js"></script>

<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            ROOT_URL: 'https:\/\/gb.ytte.top\/',
            CONTENT_URL: 'https:\/\/gb.ytte.top\/\/searchindex.json ',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script type="text/javascript" src="https://gb.ytte.top/js/insight.min.759e5002714e12761afcd512f103d39c86573165db51972dd3b24df6eddf238ed3e3e85c1988e96cba09419d1deccdeb68c15284f2c3d03049fad53c11774524.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3',
        
        hasInnerContainers: true,
    });
</script>


  </body>
</html>
